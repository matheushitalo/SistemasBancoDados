-- criar o banco
CREATE DATABASE plano_saude;


-- tabela base: pessoa
CREATE TABLE pessoa (
  id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome text NOT NULL,
  cpf varchar(14) UNIQUE,
  data_nascimento date,
  telefone text,
  email text,
  endereco text
);

-- paciente herda (sem duplicar) os dados de pessoa via referência
CREATE TABLE paciente (
  pessoa_id int PRIMARY KEY REFERENCES pessoa(id) ON DELETE CASCADE,
  numero_cartao varchar(30),
  data_cadastro date
);

-- medico herda os dados de pessoa via referência
CREATE TABLE medico (
  pessoa_id int PRIMARY KEY REFERENCES pessoa(id) ON DELETE CASCADE,
  crm varchar(20) UNIQUE,
  especialidade text
);

-- tabela associativa consulta com id próprio para permitir múltiplas consultas
CREATE TABLE consulta (
  id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  paciente_id int NOT NULL REFERENCES paciente(pessoa_id) ON DELETE RESTRICT,
  medico_id int NOT NULL REFERENCES medico(pessoa_id) ON DELETE RESTRICT,
  data_consulta timestamp NOT NULL,
  observacoes text
);

-- índices para performance em joins e buscas por data
CREATE INDEX idx_consulta_paciente ON consulta(paciente_id);
CREATE INDEX idx_consulta_medico ON consulta(medico_id);
CREATE INDEX idx_consulta_data ON consulta(data_consulta);